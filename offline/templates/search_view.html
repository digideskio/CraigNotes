<%!
    from gaesessions import get_current_session
    from view_functions import get_yui_script_tag, str_age
%>
<%def name="title()">Your Tracker - ${title_extra}</%def>
<%inherit file="base.html"/>
<%
	sess = get_current_session()
	page_type = request.get('t')
	next = request.get('next')
	newest, reviewed, hidden = 'newest', 'reviewed', 'hidden'
	if next:
		if page_type == 'newest':
			newest = 'newest&next=%s' % next
		elif page_type == 'hidden':
			hidden = 'hidden&next=%s' % next
		else:
			reviewed = 'reviewed&next=%s' % next
	f = request.get('f')
%>
<h2 style="margin-top:0">View:
	% if page_type == 'newest':
	<b>Newest Ads</b> |
	% else:
	<a href="/view?t=newest&f=${f}">Newest Ads</a> |
	% endif
	% if page_type != 'newest' and page_type != 'hidden':
	<b>Ads I've Rated/Noted</b> |
	% else:
	<a href="/view?t=reviewed&f=${f}">Ads I've Rated/Noted</a> |
	% endif
	% if page_type == 'hidden':
	<b>Hidden Ads</b>
	% else:
	<a href="/view?t=hidden&f=${f}">Hidden Ads</a>
	% endif
</h2>
<p style="margin-bottom:0"><b>Searching:</b> ${search_desc}</p>
<div class="minor" style="margin-bottom:10px">(ads for this search last retrieved from Craigslist ${age})</div>

% if not ads:
	% if more:
		<p>No more results.  <a href="${request.path}?t=${request.get('t')}&f=${request.get('f')}">Go back to the beginning.</a></p>
	% else:
	<p>
	% if page_type == 'newest':
		No ads
	% elif page_type == 'hidden':
		You haven't hidden any ads which
	% else:
		You haven't reviewed any ads which
	% endif
	meet this criteria.
	</p>
	% endif
% else:
	% if page_type == 'hidden':
	<table class="hiddenpage yui-skin-sam">
	% else:
	<table class="yui-skin-sam">
	% endif
	% for ad,cmt in ads:
	<%
		if page_type=='newest' and cmt and cmt.hidden:
			# still show "hidden" ads on the newest ads page, just less prominently
			extraHeaderClass= ' lessprom'
			infoRowStyle = ' style="display:none"'
		else:
			# unhidden ads are shown normally
			extraHeaderClass = infoRowStyle = ''
	%>
	<tr class="adheader${extraHeaderClass}" id="header${ad.cid}">
		<td class="rating">
			<%
				if cmt:
					rating = cmt.rating
				else:
					rating = 0
				for i in xrange(1,6):
					if rating >= i:
						context.write('<span class="starsel" id="star%d_%s"></span>' % (i,ad.cid))
					else:
						context.write('<span class="star" id="star%d_%s"></span>' % (i,ad.cid))
			%>
		</td>
		<td class="title">${ad.title.encode('ISO-8859-1')}</td>
		<td class="cidplus">
			<div class="cid">Ad #<a href="${ad.url}" target="_blank">${ad.cid}</a></div>
			<div class="updated">updated ${str_age(ad.update_dt, now)}</div>
			% if page_type == 'hidden' or (cmt and cmt.hidden):
			<button id="hide${ad.cid}" class="hidebtn">Don't Hide This Ad</button>
			% else:
			<button id="hide${ad.cid}" class="hidebtn">Hide This Ad</button>
			% endif
		</td>
	</tr>
	<tr class="desc" id="desc${ad.cid}"${infoRowStyle}>
		<td colspan="3">
			<div class="descval">
			<%
				context.write(ad.desc.encode('ISO-8859-1'))
			%>
			</div>
		</td>
	</tr>
	<tr class="cmt" id="cmtrow${ad.cid}"${infoRowStyle}>
		<td colspan="2" style="border-right:0">
		<%
			context.write('<div id="cmttxt%s">' % ad.cid)
			if cmt and cmt.cmt:
				context.write(cmt.cmt)
			else:
				context.write('no notes yet')
			context.write('</div>')
		%>
		</td>
		<td style="border-left:0">
			<button class="editbtn" id="edit${ad.cid}">Edit Notes</button>
			<div id="charsleft${ad.cid}" style="display:none"></div>
		</td>
	</tr>
	<tr><td class="gap" colspan="3" id="gap${ad.cid}">&nbsp;</td></tr>
	% endfor
	</table>
% endif

% if request.get('next') or more:
<p class="pages">
	% if request.get('next'):
		<a href="${request.path}?t=${request.get('t')}&f=${request.get('f')}">Back to page 1</a>
		% if more:
		|
		% endif
	% endif
	% if more:
		<a href="${request.path}?t=${request.get('t')}&f=${request.get('f')}&next=${more}">Next 25 results</a>
	% endif
</p>
% endif

<%def name="footer()">
${get_yui_script_tag() | n}
<script  type="text/javascript">//<![CDATA[
CIDS = ${str([str(ad.cid) for ad,cmt in ads])};
SHOW_HIDDEN_ADS = ${int(request.get('t') == 'hidden')};
//]]></script>
<script type="text/javascript" src="/js/view.js"></script>
</%def>
