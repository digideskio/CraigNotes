<%!
    from gaesessions import get_current_session
    from view_functions import get_yui_script_tag, str_age
%>
<%def name="title()">${name|h}</%def>
<%def name="page_title()"><a href="/tracker">Your Tracker</a> - ${name|h}</%def>
<%inherit file="base.html"/>
<%
	sess = get_current_session()
	page_type = request.get('t')
	next = request.get('next')
	f = request.get('f')
%>

<%def name="header2()">
	<%
		page_type = request.get('t')
		f = request.get('f')
		newest_id = hidden_id = reviewed_id = ""
		if page_type == 'newest':
			newest_id = ' id="youarehere"'
		elif page_type == 'hidden':
			hidden_id = ' id="youarehere"'
		else:
			reviewed_id = ' id="youarehere"'

		first_ad_num = (page-1) * ADS_PER_PAGE + 1
		last_ad_num  = first_ad_num + len(ads) - 1
		if more:
			page_txt = page
		else:
			page_txt = 'page %s of %s' % (page, page)
	%>
	<div style="border-bottom: 1px solid #888888;text-align:center">
		<div id="nav">
			<ul>
				<li${newest_id}><a href="/view?t=newest&f=${f}">Newest Ads</a></li>
				<li${reviewed_id}><a href="/view?t=reviewed&f=${f}">Ads I've Rated/Noted</a></li>
				<li${hidden_id}><a href="/view?t=hidden&f=${f}">Hidden Ads</a></li>
			</ul>
		</div>
		<p id="viewing">Viewing ${page_type} ads ${first_ad_num} to ${last_ad_num} (${page_txt}):
		% if more:
			(<a href="${request.path}?t=${page_type}&f=${f}&next=${more}&page=${page+1}">next ${ADS_PER_PAGE} results</a>)
		% endif
		</p>

		<p style="margin:auto;max-width:750px">
			<b>Searching:</b> ${search_desc}
			<span class="minor">(ads for this search last retrieved from Craigslist ${age})</span>
		</p>
	</div>
</%def>

% if not ads:
	% if more:
		<p>No more results.  <a href="${request.path}?t=${page_type}&f=${f}">Go back to the beginning.</a></p>
	% else:
	<p>
	% if page_type == 'newest':
		No ads
	% elif page_type == 'hidden':
		You haven't hidden any ads which
	% else:
		You haven't reviewed any ads which
	% endif
	meet this criteria.
	</p>
	% endif
% else:
	% if page_type == 'hidden':
	<table class="hiddenpage yui-skin-sam">
	% else:
	<table class="yui-skin-sam">
	% endif
	% for ad,cmt in ads:
	<%
		if page_type=='newest' and cmt and cmt.hidden:
			# still show "hidden" ads on the newest ads page, just less prominently
			extraHeaderClass= ' lessprom'
			infoRowStyle = ' style="display:none"'
		else:
			# unhidden ads are shown normally
			extraHeaderClass = infoRowStyle = ''
	%>
	<tr class="adheader${extraHeaderClass}" id="header${ad.cid}">
		<td class="rating">
			<%
				if cmt:
					rating = cmt.rating
				else:
					rating = 0
				for i in xrange(1,6):
					if rating >= i:
						context.write('<span class="starsel" id="star%d_%s"></span>' % (i,ad.cid))
					else:
						context.write('<span class="star" id="star%d_%s"></span>' % (i,ad.cid))
			%>
		</td>
		<td class="title">${ad.title.encode('ISO-8859-1')}</td>
		<td class="cidplus">
			<div class="cid">Ad #<a href="${ad.url}" target="_blank">${ad.cid}</a></div>
			<div class="updated">updated ${str_age(ad.update_dt, now)}</div>
			% if page_type == 'hidden' or (cmt and cmt.hidden):
			<button id="hide${ad.cid}" class="hidebtn">Don't Hide This Ad</button>
			% else:
			<button id="hide${ad.cid}" class="hidebtn">Hide This Ad</button>
			% endif
		</td>
	</tr>
	<tr class="desc" id="desc${ad.cid}"${infoRowStyle}>
		<td colspan="3">
			<div class="descval">
			<%
				context.write(ad.desc.encode('ISO-8859-1'))
			%>
			</div>
		</td>
	</tr>
	<tr class="cmt" id="cmtrow${ad.cid}"${infoRowStyle}>
		<td colspan="2" class="cmtval">
		<%
			context.write('<div id="cmttxt%s">' % ad.cid)
			if cmt and cmt.cmt:
				context.write(cmt.cmt)
			else:
				context.write('no notes yet')
			context.write('</div>')
		%>
		</td>
		<td style="border-left:0;width:146px">
			<button class="editbtn" id="edit${ad.cid}">Edit Notes</button>
			<div id="charsleft${ad.cid}" style="display:none"></div>
		</td>
	</tr>
	<tr><td class="gap" colspan="3" id="gap${ad.cid}">&nbsp;</td></tr>
	% endfor
	</table>
% endif

% if next or more:
<p class="pages">
	% if next:
		<a href="${request.path}?t=${page_type}&f=${f}">Back to page 1</a>
		% if more:
		|
		% endif
	% endif
	% if more:
		<a href="${request.path}?t=${page_type}&f=${f}&next=${more}&page=${page+1}">Next ${ADS_PER_PAGE} results</a>
	% endif
</p>
% endif

<%def name="footer()">
${get_yui_script_tag() | n}
<script  type="text/javascript">//<![CDATA[
CIDS = ${str([str(ad.cid) for ad,cmt in ads])};
SHOW_HIDDEN_ADS = ${int(request.get('t') == 'hidden')};
//]]></script>
<script type="text/javascript" src="/js/view.js"></script>
</%def>
