<%!
    from controller_functions import is_logged_in
    from gaesessions import get_current_session
    from models.User import User
    from view_functions import make_user_header_html
%>
<%
    session = get_current_session()
    user_is_logged_in = is_logged_in() is not False
    if user_is_logged_in:
        ret = User.note_user_activity(session['my_id'], session['my_last_seen'])
        if ret:
            session['my_last_seen'] = ret
        elif ret is False:
            import logging
            logging.warn("terminating session which specified an invalid user ID %s (should only happen if a user is deleted and then they access the site w/o clearing their cookies)" % session['my_id'])
            session.terminate()  # user no longer exists
            user_is_logged_in = False

    nav_find_id = nav_race_id = nav_share_id = ""
    if request.path.startswith('/find'):
        nav_find_id = ' id="youarehere"'
    elif request.path.startswith('/race'):
        nav_race_id = ' id="youarehere"'
    elif request.path.startswith('/share'):
        nav_share_id = ' id="youarehere"'
%>
<%def name="title_sep()"> - </%def>
<%def name="page_title()">${next.title()}</%def>
<%def name="subtitle()"></%def>
<%def name="head()"></%def>
<%def name="sidebar_body()"></%def>
<%def name="sidebar()"><div id="sidebar">${next.sidebar_body()}</div></%def>
<%def name="footer()"></%def>
<%def name="get_if_present(var_name)">
	% if context.get(var_name, None):
		${context[var_name]}
	% endif
</%def>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>${next.title() | h}${next.title_sep()}Race Photo Hub</title>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.1.0/build/cssreset/reset.css&amp;3.1.0/build/cssfonts/fonts.css&amp;3.1.0/build/cssbase/base.css"/>
    <link rel="stylesheet" type="text/css" href="/css/base.css"/>
${next.head()}
</head>
<body>
    <noscript><div class="errmsg">Race Photo Hub works best with JavaScript enabled.</div></noscript>
    <div id="wrap">
		<a id="logo" href="/"></a>
        <div id="header">
            <div class="hf-links" id="header-links">
                <b>${make_user_header_html(user_is_logged_in, session, request.path)}</b> |
                <a href="/about">about</a>
            </div>
        </div>
        <div id="navwrap">
            <div id="nav">
            <ul>
                <li${nav_share_id}><a href="/share/choose_race">Share Photos</a></li>
                <li${nav_find_id}><a href="/find_photos">Find Photos</a></li>
                <li${nav_race_id}><a href="/races">Browse Races</a></li>
            </ul>
            </div>
        </div>
        % if request.get('err'):
        <div class="errmsg">${request.get('err') | h}</div>
        % endif
        % if request.get('msg'):
        <div class="infomsg">${request.get('msg') | h}</div>
        % endif
        <div id="titles">
			<div id="title">${next.page_title() | h}
				<span id="subtitle">${next.subtitle() | h}</span>
			</div>
		</div>
        <div id="main">
            ${next.body()}
        </div>
        ${next.sidebar()}
        <div id="base"></div>
    </div>

    <div id="footer">
        <div class="hf-links" id="footer-links">
            <a href="/about">About</a>
            <a href="/contact">Contact Us</a>
            <a href="/faq">FAQ</a>
            <a href="http://racephotohub.uservoice.com/forums/55956-general?lang=en" target="_blank">Give us Feedback!</a>
            <a href="/legal">Legal</a>
            <a href="/privacy">Privacy</a>
        </div>
        <p id="copyright">&copy; 2010 RacePhotoHub.com</p>
    </div>
${next.footer()}
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15571850-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
